<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>Court Elo</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:#0d1117; --surface:#161b22; --border:#21262d; --border2:#30363d;
    --accent:#e85d04; --accent2:#f77f30; --text:#e2e8f0; --muted:#94a3b8;
    --dim:#6b7280; --dimmer:#374151; --green:#22c55e; --red:#ef4444;
    --gold:#FFD700; --silver:#C0C0C0; --bronze:#CD7F32;
    --amber:#f59e0b; --amber-bg:#451a03;
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh}
  ::-webkit-scrollbar{width:4px;height:4px}
  ::-webkit-scrollbar-track{background:var(--surface)}
  ::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}
  select option{background:var(--surface);color:var(--text)}
  @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideIn{from{transform:translateY(-48px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .anim{animation:fadeUp .35s ease both}

  /* HEADER */
  #header{position:sticky;top:0;z-index:100;background:rgba(13,17,23,.93);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 16px}
  #header-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:4px;padding-top:10px}
  #logo{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--accent);letter-spacing:3px;line-height:1}
  #logo span{font-size:10px;color:var(--dimmer);font-family:'DM Mono',monospace;letter-spacing:2px;margin-left:6px;vertical-align:middle}
  #tabs{display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch}
  #tabs::-webkit-scrollbar{display:none}
  .tab-btn{background:none;border:none;cursor:pointer;font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;padding:9px 13px;border-bottom:3px solid transparent;color:var(--dim);transition:all .2s;white-space:nowrap}
  .tab-btn:hover,.tab-btn.active{color:var(--accent)!important}
  .tab-btn.active{border-bottom-color:var(--accent)}
  #admin-indicator{font-family:'DM Mono',monospace;font-size:11px;padding:4px 10px;border-radius:6px;background:#14532d;color:#86efac;cursor:pointer;white-space:nowrap;margin-bottom:8px}
  #admin-indicator.off{background:var(--border);color:var(--dim)}

  /* MAIN */
  #main{max-width:900px;margin:0 auto;padding:22px 14px 40px}

  /* PLAYER BANNER */
  #player-banner{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 16px}
  #player-banner-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  /* INPUTS */
  .inp{width:100%;padding:9px 13px;background:var(--bg);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border .2s;-webkit-appearance:none}
  .inp:focus{border-color:var(--accent)}
  input[type="date"].inp{color-scheme:dark}
  input[type="password"].inp{letter-spacing:3px}

  /* BUTTONS */
  .btn{padding:9px 18px;border-radius:8px;border:none;cursor:pointer;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;font-size:14px;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;gap:5px}
  .pri{background:var(--accent);color:#fff}.pri:hover{background:var(--accent2);transform:translateY(-1px)}
  .ghost{background:transparent;border:1px solid var(--border2);color:var(--muted)}.ghost:hover{border-color:var(--accent);color:var(--accent)}
  .danger{background:transparent;border:1px solid #7f1d1d;color:var(--red)}.danger:hover{background:#7f1d1d22}
  .success{background:#14532d;color:#86efac;border:none}.success:hover{background:#166534}
  .sm{padding:6px 12px;font-size:13px;border-radius:7px}
  .btn:active{transform:scale(.97)}

  /* CARDS / ROWS */
  .card{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:18px}
  .row{display:flex;align-items:center;gap:12px;padding:12px 15px;background:var(--surface);border-radius:12px;border:1px solid var(--border);transition:all .2s;margin-bottom:7px}
  .row:hover{border-color:rgba(232,93,4,.35)}

  /* PENDING ROW */
  .pending-row{border-color:var(--amber-bg)!important;background:rgba(69,26,3,.18)!important}
  .pending-badge{padding:2px 8px;background:var(--amber-bg);color:var(--amber);border-radius:10px;font-size:11px;font-family:'DM Mono',monospace;animation:pulse 2s infinite}

  /* CHIPS */
  .chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:14px;background:#21262d;font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)}

  /* LABELS */
  label,.lbl{font-size:11px;color:var(--dim);font-family:'DM Mono',monospace;letter-spacing:1px;display:block;margin-bottom:6px}

  /* SEGMENT */
  .seg-wrap{background:var(--surface);border:1px solid var(--border);border-radius:8px;display:inline-flex;padding:3px;gap:2px}
  .seg{padding:5px 13px;border-radius:6px;border:none;cursor:pointer;font-family:'Bebas Neue',sans-serif;letter-spacing:1px;font-size:13px;transition:all .15s;color:var(--dim);background:transparent}
  .seg.active{background:var(--accent);color:#fff}

  /* TAGS */
  .tag{padding:5px 11px;border-radius:6px;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;border:1px solid var(--border2);background:#21262d;color:var(--muted);transition:all .15s;user-select:none}
  .tag.sel{background:var(--accent);color:#fff;border-color:var(--accent)}
  .tag:hover:not(.sel){border-color:var(--accent);color:var(--accent)}

  /* TYPE BTNS */
  .type-btn{padding:7px 12px;border-radius:7px;border:1px solid var(--border2);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;background:#21262d;color:var(--muted);transition:all .15s}
  .type-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  /* BRACKET */
  .bracket-cell{background:var(--surface);border:1px solid var(--border2);border-radius:9px;padding:9px 11px;min-width:150px;transition:border .2s}
  .b-player{padding:5px 9px;border-radius:5px;cursor:pointer;font-size:13px;font-family:'DM Sans',sans-serif;font-weight:500;transition:all .15s;margin-bottom:2px}
  .b-player:hover:not(.won):not(.bye){background:rgba(232,93,4,.12)}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px}
  .modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;width:100%;max-width:380px}
  .modal-box h3{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:#f1f5f9;margin-bottom:16px}

  /* KOTC */
  .kotc-place-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .kotc-place-badge{font-family:'Bebas Neue',sans-serif;font-size:15px;min-width:28px;text-align:center}
  .kotc-elo-badge{font-family:'DM Mono',monospace;font-size:12px;min-width:46px;text-align:right}

  /* TOAST */
  #toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);padding:10px 22px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.6);transition:transform .3s ease;white-space:nowrap;pointer-events:none}
  #toast.show{transform:translateX(-50%) translateY(0)}

  /* GRID HELPERS */
  .g2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .g3{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center}
  .flex{display:flex}.fw{flex-wrap:wrap}
  .gap6{gap:6px}.gap8{gap:8px}.gap10{gap:10px}.gap12{gap:12px}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}
  .mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}.mb20{margin-bottom:20px}
  .w100{width:100%}.center{text-align:center}
  .hidden{display:none!important}
  .section-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:#f1f5f9;margin-bottom:16px}
  .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:8px}
  .badge-done{padding:2px 8px;background:#14532d;color:#86efac;border-radius:10px;font-size:11px;font-family:'DM Mono',monospace}
  .badge-active{padding:2px 8px;background:#1e3a5f;color:#93c5fd;border-radius:10px;font-size:11px;font-family:'DM Mono',monospace}
  .k-ref{display:flex;justify-content:space-between;padding:6px 10px;background:var(--bg);border-radius:6px;font-size:12px;color:var(--muted)}
  .k-ref span{color:var(--accent);font-family:'DM Mono',monospace}

  /* VERIFY ACTIONS */
  .verify-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}

  @media(max-width:500px){
    .g2{grid-template-columns:1fr}
    .tab-btn{padding:9px 10px;font-size:13px}
    #logo{font-size:24px}
  }
</style>
</head>
<body>

<div id="toast"></div>

<!-- PIN MODAL -->
<div id="pin-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <h3 id="pin-modal-title">ADMIN LOGIN</h3>
    <p id="pin-modal-desc" style="font-size:13px;color:var(--muted);margin-bottom:14px;">Enter your admin PIN to continue.</p>
    <label>PIN</label>
    <input class="inp" type="password" id="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20" style="margin-bottom:14px;" onkeydown="if(event.key==='Enter')submitPin()"/>
    <div id="pin-error" class="hidden" style="color:var(--red);font-size:12px;font-family:'DM Mono',monospace;margin-bottom:10px;">Incorrect PIN</div>
    <div style="display:flex;gap:8px;">
      <button class="btn pri sm" style="flex:1;" onclick="submitPin()">ENTER</button>
      <button class="btn ghost sm" onclick="closePinModal()">CANCEL</button>
    </div>
  </div>
</div>

<!-- EDIT PLAYER MODAL -->
<div id="edit-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <h3>EDIT PLAYER</h3>
    <label>NAME</label>
    <input class="inp" id="edit-player-name" style="margin-bottom:14px;" placeholder="Player name‚Ä¶" onkeydown="if(event.key==='Enter')saveEditPlayer()"/>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn pri sm" style="flex:1;" onclick="saveEditPlayer()">SAVE</button>
      <button class="btn danger sm" onclick="deletePlayer()">üóë DELETE</button>
      <button class="btn ghost sm" onclick="closeEditModal()">CANCEL</button>
    </div>
  </div>
</div>

<!-- SET PIN MODAL -->
<div id="setpin-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <h3>SET ADMIN PIN</h3>
    <p style="font-size:13px;color:var(--muted);margin-bottom:14px;">Choose a PIN only you know. You'll need this to verify matches and edit players.</p>
    <label>NEW PIN</label>
    <input class="inp" type="password" id="setpin-new" placeholder="Enter PIN‚Ä¶" style="margin-bottom:10px;" maxlength="20"/>
    <label>CONFIRM PIN</label>
    <input class="inp" type="password" id="setpin-confirm" placeholder="Confirm PIN‚Ä¶" style="margin-bottom:14px;" maxlength="20" onkeydown="if(event.key==='Enter')savePin()"/>
    <div id="setpin-error" class="hidden" style="color:var(--red);font-size:12px;font-family:'DM Mono',monospace;margin-bottom:10px;"></div>
    <div style="display:flex;gap:8px;">
      <button class="btn pri sm" style="flex:1;" onclick="savePin()">SET PIN</button>
      <button class="btn ghost sm" onclick="closeSetPinModal()">CANCEL</button>
    </div>
  </div>
</div>

<div id="header">
  <div id="header-inner">
    <div style="display:flex;align-items:baseline;gap:8px;">
      <div id="logo">COURT ELO <span>v3.0</span></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding-bottom:6px;">
      <button id="admin-indicator" class="off" onclick="handleAdminClick()">üîí ADMIN</button>
      <div id="tabs">
        <button class="tab-btn active" data-tab="rankings">üèÖ Rankings</button>
        <button class="tab-btn" data-tab="log">üéæ Log</button>
        <button class="tab-btn" data-tab="tournament">üèÜ Tournaments</button>
        <button class="tab-btn" data-tab="history">üìã History</button>
        <button class="tab-btn" data-tab="h2h">‚öîÔ∏è H2H</button>
        <button class="tab-btn" id="verify-tab-btn" data-tab="verify" style="display:none;">‚è≥ Verify<span id="pending-count-badge" style="display:none;margin-left:4px;background:var(--amber);color:#000;border-radius:10px;padding:1px 6px;font-size:11px;"></span></button>
      </div>
    </div>
  </div>
</div>

<!-- PLAYER IDENTITY BANNER -->
<div id="player-banner">
  <div id="player-banner-inner">
    <span style="font-size:12px;color:var(--dim);font-family:'DM Mono',monospace;white-space:nowrap;">PLAYING AS:</span>
    <select class="inp" id="current-player-select" style="max-width:200px;" onchange="setCurrentPlayer(this.value)">
      <option value="">Select your name‚Ä¶</option>
    </select>
    <span id="current-player-display" style="font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--accent);display:none;"></span>
  </div>
</div>

<div id="main">

  <!-- RANKINGS -->
  <div id="tab-rankings">
    <div class="flex fw gap10 mb16" style="justify-content:space-between;align-items:flex-start;">
      <div>
        <div class="section-title" style="margin-bottom:2px;">PLAYER RANKINGS</div>
        <div id="rank-subtitle" style="font-size:11px;color:var(--dimmer);" class="mono"></div>
      </div>
      <div class="flex fw gap8 mt8">
        <div class="seg-wrap">
          <button class="seg active" data-rv="singles" onclick="setRankView('singles')">SINGLES</button>
          <button class="seg" data-rv="doubles" onclick="setRankView('doubles')">DOUBLES</button>
        </div>
        <button id="add-player-btn" class="btn ghost sm hidden" onclick="toggleAddPlayer()">+ PLAYER</button>
      </div>
    </div>
    <div id="add-player-form" class="card mb16 hidden">
      <div class="flex gap8">
        <input class="inp" id="new-player-name" placeholder="Player name‚Ä¶" onkeydown="if(event.key==='Enter')addPlayer()"/>
        <button class="btn pri sm" onclick="addPlayer()">ADD</button>
      </div>
    </div>
    <div id="rankings-list"></div>
    <div class="mt20" style="padding:14px;background:var(--surface);border-radius:12px;border:1px solid var(--border);">
      <div style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;letter-spacing:1px;margin-bottom:10px;">K-FACTOR REFERENCE</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:6px;">
        <div class="k-ref">üéæ Singles 1 Set<span>K=20</span></div>
        <div class="k-ref">üèÜ Singles Bo3<span>K=40</span></div>
        <div class="k-ref">üë• Doubles 1 Set<span>K=20</span></div>
        <div class="k-ref">üë• Doubles Bo3<span>K=40</span></div>
        <div class="k-ref">üëë KOTC 1st place<span>+20 ELO</span></div>
        <div class="k-ref">üëë KOTC 2nd place<span>+5 ELO</span></div>
        <div class="k-ref">üèÖ Tourney match<span>+5 K bonus</span></div>
        <div class="k-ref">ü•á Tourney winner<span>+50 ELO</span></div>
        <div class="k-ref">ü•à Tourney runner-up<span>+15 ELO</span></div>
        <div class="k-ref" style="grid-column:1/-1;border-top:1px solid var(--border);padding-top:8px;">‚ö° Upset bonus (beat player 3+ ranks above)<span>+5 per extra rank</span></div>
        <div class="k-ref" style="grid-column:1/-1;">üíÄ Choke penalty (lose to player 3+ ranks below)<span>‚àí5 base + 5/rank</span></div>
      </div>
    </div>
  </div>

  <!-- LOG MATCH -->
  <div id="tab-log" class="hidden">
    <div class="card">
      <div class="section-title">SUBMIT MATCH</div>
      <div id="no-player-warning" class="hidden mb16" style="padding:12px;background:var(--amber-bg);border-radius:10px;border:1px solid var(--amber);font-size:13px;color:var(--amber);">
        ‚ö†Ô∏è Select your name in the banner above before submitting a match.
      </div>
      <div class="mb16">
        <div class="lbl">MATCH TYPE</div>
        <div class="flex fw gap6" id="match-type-btns"></div>
      </div>
      <div class="mb16" style="padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--border);">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:0;">
          <input type="checkbox" id="is-tourney" style="accent-color:var(--accent);width:15px;height:15px;" onchange="toggleTourneySelect()"/>
          <span style="font-size:13px;color:var(--muted);font-family:'DM Mono',monospace;">TOURNAMENT MATCH (+5 K bonus)</span>
        </label>
        <div id="tourney-select-wrap" class="hidden mt8">
          <select class="inp" id="log-tourney-id"><option value="">Link to tournament‚Ä¶</option></select>
          <div id="no-tourney-msg" class="hidden mt8" style="font-size:12px;color:var(--dim);font-family:'DM Mono',monospace;">No active tournaments ‚Äî create one first</div>
        </div>
      </div>
      <div class="g2 mb16" id="player-selects"></div>
      <div class="g2 mb20">
        <div>
          <label>SCORE (optional)</label>
          <input class="inp" id="log-score" placeholder="e.g. 6-3, 7-5"/>
        </div>
        <div>
          <label>DATE</label>
          <input class="inp" type="date" id="log-date"/>
        </div>
      </div>
      <button class="btn pri w100" style="font-size:16px;padding:13px;" onclick="submitMatch()">SUBMIT FOR VERIFICATION</button>
      <div style="margin-top:10px;text-align:center;font-size:12px;color:var(--dim);font-family:'DM Mono',monospace;">Matches are verified by the admin before they count toward rankings.</div>
    </div>
  </div>

  <!-- VERIFY (admin only) -->
  <div id="tab-verify" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
      <div class="section-title" style="margin-bottom:0;">PENDING VERIFICATION</div>
      <button class="btn ghost sm" onclick="rejectAllPending()" id="reject-all-btn" style="display:none;">REJECT ALL</button>
    </div>
    <div id="verify-list"></div>
  </div>

  <!-- TOURNAMENTS -->
  <div id="tab-tournament" class="hidden">
    <div class="section-title">TOURNAMENTS</div>
    <div class="card mb20">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;color:var(--dim);margin-bottom:14px;">CREATE NEW</div>
      <div class="g2 mb12">
        <div>
          <label>NAME</label>
          <input class="inp" id="t-name" placeholder="e.g. Summer Open"/>
        </div>
        <div>
          <label>FORMAT</label>
          <div class="flex gap6">
            <button class="type-btn active" data-tf="type" data-val="bracket" onclick="setTForm('type','bracket',this)">üèÜ Bracket</button>
            <button class="type-btn" data-tf="type" data-val="kotc" onclick="setTForm('type','kotc',this)">üëë KOTC</button>
          </div>
        </div>
      </div>
      <div class="g2 mb12">
        <div>
          <label>SINGLES / DOUBLES</label>
          <div class="flex gap6">
            <button class="type-btn active" data-tf="isDoubles" data-val="false" onclick="setTForm('isDoubles',false,this)">Singles</button>
            <button class="type-btn" data-tf="isDoubles" data-val="true" onclick="setTForm('isDoubles',true,this)">Doubles</button>
          </div>
        </div>
        <div id="match-type-select-div">
          <label>MATCH TYPE</label>
          <select class="inp" id="t-match-type">
            <option value="singles_1set">Singles ‚Äì 1 Set</option>
            <option value="singles_bo3">Singles ‚Äì Best of 3</option>
            <option value="doubles_1set">Doubles ‚Äì 1 Set</option>
            <option value="doubles_bo3">Doubles ‚Äì Best of 3</option>
          </select>
        </div>
      </div>
      <div id="t-participants-wrap" class="mb12">
        <label>PARTICIPANTS (tap to add/remove)</label>
        <div class="flex fw gap6 mt8" id="t-participants-tags"></div>
        <div id="t-participants-count" style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;margin-top:5px;"></div>
      </div>
      <button class="btn pri sm" onclick="createTournament()">CREATE TOURNAMENT</button>
    </div>
    <div id="tournament-list"></div>
  </div>

  <!-- HISTORY -->
  <div id="tab-history" class="hidden">
    <div class="section-title">MATCH HISTORY</div>
    <div id="history-list"></div>
  </div>

  <!-- H2H -->
  <div id="tab-h2h" class="hidden">
    <div class="section-title">HEAD TO HEAD</div>
    <div class="g3 mb16">
      <select class="inp" id="h2h-a" onchange="renderH2H()"><option value="">Player A‚Ä¶</option></select>
      <span style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--accent);text-align:center;">VS</span>
      <select class="inp" id="h2h-b" onchange="renderH2H()"><option value="">Player B‚Ä¶</option></select>
    </div>
    <div id="h2h-result"></div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const K_FACTORS = {
  singles_1set:20, singles_bo3:40, doubles_1set:20, doubles_bo3:40,
  tournament_bonus_winner:50, tournament_bonus_runner:15, tournament_match_bonus:5,
};
const MATCH_TYPES = {
  singles_1set:{label:'1 Set',emoji:'üéæ',doubles:false},
  singles_bo3: {label:'Best of 3',emoji:'üèÜ',doubles:false},
  doubles_1set:{label:'1 Set',emoji:'üéæ',doubles:true},
  doubles_bo3: {label:'Best of 3',emoji:'üèÜ',doubles:true},
};
const INIT_PLAYERS = [{id:'p1',name:'Alex'},{id:'p2',name:'Jordan'},{id:'p3',name:'Taylor'},{id:'p4',name:'Morgan'}];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let players=[], matches=[], tournaments=[], pendingMatches=[];
let rankView='singles', tFormState={type:'bracket',isDoubles:false,participants:[]};
let activeTourneyId=null, isAdmin=false, currentPlayerId='';
let editingPlayerId=null, pinCallback=null;

// ‚îÄ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadData() {
  try {
    players     = JSON.parse(localStorage.getItem('ce3:players')  ||'null') || INIT_PLAYERS;
    matches     = JSON.parse(localStorage.getItem('ce3:matches')  ||'[]');
    tournaments = JSON.parse(localStorage.getItem('ce3:tournaments')||'[]');
    pendingMatches = JSON.parse(localStorage.getItem('ce3:pending')||'[]');
  } catch { players=INIT_PLAYERS; matches=[]; tournaments=[]; pendingMatches=[]; }
}
function saveData() {
  localStorage.setItem('ce3:players',     JSON.stringify(players));
  localStorage.setItem('ce3:matches',     JSON.stringify(matches));
  localStorage.setItem('ce3:tournaments', JSON.stringify(tournaments));
  localStorage.setItem('ce3:pending',     JSON.stringify(pendingMatches));
}
function getStoredPin() { return localStorage.getItem('ce3:pin'); } // returns null if not set
function setStoredPin(p) { localStorage.setItem('ce3:pin',p); }

// ‚îÄ‚îÄ‚îÄ KOTC SCORING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function kotcPlacementElo(i) {
  if(i===0) return 20; if(i===1) return 5; if(i===2) return 0;
  return -(i-2)*5;
}

// ‚îÄ‚îÄ‚îÄ ELO ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function expected(rA,rB){return 1/(1+Math.pow(10,(rB-rA)/400));}
function eloDelta(rA,rB,won,k){return Math.round(k*((won?1:0)-expected(rA,rB)));}
function getRanks(bucket){
  const sorted=Object.entries(bucket).sort((a,b)=>b[1].elo-a[1].elo);
  const r={}; sorted.forEach(([id],i)=>r[id]=i); return r;
}
function rankModifier(wRank,lRank){const d=lRank-wRank;return d>2?(d-2)*5:0;}
function lossPenalty(lRank,wRank){const d=lRank-wRank;return 5+(d>2?(d-2)*5:0);}
function freshStats(){return{elo:1200,wins:0,losses:0,matches:0};}

function computeStats() {
  const s={},d={};
  players.forEach(p=>{s[p.id]=freshStats();d[p.id]=freshStats();});
  matches.forEach(m=>{
    const isD=MATCH_TYPES[m.type]?.doubles??false;
    const bucket=isD?d:s;
    const kBase=K_FACTORS[m.type]+(m.tournamentId?K_FACTORS.tournament_match_bonus:0);
    if(!isD){
      const wId=m.winners[0],lId=m.losers[0];
      const w=bucket[wId],l=bucket[lId]; if(!w||!l) return;
      const ranks=getRanks(bucket);
      const wR=ranks[wId]??0,lR=ranks[lId]??0;
      const dw=eloDelta(w.elo,l.elo,true,kBase),dl=eloDelta(l.elo,w.elo,false,kBase);
      const bonus=rankModifier(wR,lR),pen=lossPenalty(lR,wR);
      w.elo+=dw+bonus; l.elo+=dl-pen;
      w.wins++;l.losses++;w.matches++;l.matches++;
    } else {
      const [w1,w2]=m.winners,[l1,l2]=m.losers;
      if(!bucket[w1]||!bucket[w2]||!bucket[l1]||!bucket[l2]) return;
      const ranks=getRanks(bucket);
      const wAvgR=((ranks[w1]??0)+(ranks[w2]??0))/2,lAvgR=((ranks[l1]??0)+(ranks[l2]??0))/2;
      const wAvgE=(bucket[w1].elo+bucket[w2].elo)/2,lAvgE=(bucket[l1].elo+bucket[l2].elo)/2;
      const dw=eloDelta(wAvgE,lAvgE,true,kBase),dl=eloDelta(lAvgE,wAvgE,false,kBase);
      const bonus=rankModifier(wAvgR,lAvgR),pen=lossPenalty(lAvgR,wAvgR);
      [w1,w2].forEach(id=>{bucket[id].elo+=dw+bonus;bucket[id].wins++;bucket[id].matches++;});
      [l1,l2].forEach(id=>{bucket[id].elo+=dl-pen;bucket[id].losses++;bucket[id].matches++;});
    }
  });
  tournaments.filter(t=>t.type==='kotc'&&t.status==='done').forEach(t=>{
    const bucket=t.isDoubles?d:s;
    const pl=t.placements||[];
    pl.forEach((id,i)=>{if(bucket[id])bucket[id].elo+=kotcPlacementElo(i);});
    if(!pl.length){(t.winner||[]).forEach(id=>{if(bucket[id])bucket[id].elo+=20;});(t.second||[]).forEach(id=>{if(bucket[id])bucket[id].elo+=5;});}
  });
  tournaments.filter(t=>t.type==='bracket'&&t.status==='done').forEach(t=>{
    const bucket=t.isDoubles?d:s;
    const ch=Array.isArray(t.champion)?t.champion:(t.champion?[t.champion]:[]);
    const ru=Array.isArray(t.runnerUp)?t.runnerUp:(t.runnerUp?[t.runnerUp]:[]);
    ch.forEach(id=>{if(bucket[id])bucket[id].elo+=K_FACTORS.tournament_bonus_winner;});
    ru.forEach(id=>{if(bucket[id])bucket[id].elo+=K_FACTORS.tournament_bonus_runner;});
  });
  return{singles:s,doubles:d};
}
function sortedPlayers(bucket){return players.map(p=>({...p,...(bucket[p.id]||freshStats())})).sort((a,b)=>b.elo-a.elo);}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pName(id){return players.find(p=>p.id===id)?.name??'?';}
function rankColor(i){return i===0?'var(--gold)':i===1?'var(--silver)':i===2?'var(--bronze)':'var(--accent)';}
function el(id){return document.getElementById(id);}
function showToast(msg,ok=true){
  const t=el('toast');t.textContent=msg;
  t.style.background=ok?'#14532d':'#7f1d1d';t.style.color=ok?'#86efac':'#fca5a5';
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2600);
}

// ‚îÄ‚îÄ‚îÄ ADMIN / PIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleAdminClick(){
  if(isAdmin){logoutAdmin();return;}
  const pin=getStoredPin();
  if(pin===null){openSetPinModal();return;}  // no PIN set yet
  openPinModal('ADMIN LOGIN','Enter your admin PIN.',()=>{loginAdmin();});
}
function loginAdmin(){
  isAdmin=true;
  el('admin-indicator').textContent='üîì ADMIN';
  el('admin-indicator').classList.remove('off');
  el('add-player-btn').classList.remove('hidden');
  el('verify-tab-btn').style.display='';
  updatePendingBadge();
  renderRankings();
  showToast('Admin mode on üîì');
}
function logoutAdmin(){
  isAdmin=false;
  el('admin-indicator').textContent='üîí ADMIN';
  el('admin-indicator').classList.add('off');
  el('add-player-btn').classList.add('hidden');
  el('verify-tab-btn').style.display='none';
  if(el('tab-verify').offsetParent!==null) switchTab('rankings');
  renderRankings();
  showToast('Logged out');
}
function openPinModal(title,desc,cb){
  pinCallback=cb;
  el('pin-modal-title').textContent=title;
  el('pin-modal-desc').textContent=desc;
  el('pin-input').value='';
  el('pin-error').classList.add('hidden');
  el('pin-modal').classList.remove('hidden');
  setTimeout(()=>el('pin-input').focus(),100);
}
function closePinModal(){el('pin-modal').classList.add('hidden');pinCallback=null;}
function submitPin(){
  const entered=el('pin-input').value.trim();
  const stored=getStoredPin();
  if(stored!==null && entered===stored){
    closePinModal();
    if(pinCallback) pinCallback();
    else loginAdmin(); // fallback: always login if PIN matches
  } else {
    el('pin-error').classList.remove('hidden');
  }
}
function openSetPinModal(){el('setpin-modal').classList.remove('hidden');setTimeout(()=>el('setpin-new').focus(),100);}
function closeSetPinModal(){el('setpin-modal').classList.add('hidden');}
function savePin(){
  const np=el('setpin-new').value.trim(),cp=el('setpin-confirm').value.trim();
  if(!np){el('setpin-error').textContent='PIN cannot be empty';el('setpin-error').classList.remove('hidden');return;}
  if(np!==cp){el('setpin-error').textContent='PINs do not match';el('setpin-error').classList.remove('hidden');return;}
  setStoredPin(np);closeSetPinModal();loginAdmin();showToast('PIN set! You are now admin üîì');
}

// ‚îÄ‚îÄ‚îÄ PLAYER IDENTITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setCurrentPlayer(id){
  currentPlayerId=id;
  const p=players.find(x=>x.id===id);
  el('current-player-display').textContent=p?p.name:'';
  el('current-player-display').style.display=p?'':'none';
  renderLogForm();
}
function populatePlayerBanner(){
  const sel=el('current-player-select');
  const prev=sel.value;
  sel.innerHTML='<option value="">Select your name‚Ä¶</option>'+players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  if(prev) sel.value=prev;
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tabId){
  document.querySelectorAll('[id^="tab-"]').forEach(t=>t.classList.add('hidden'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  el('tab-'+tabId).classList.remove('hidden');
  document.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active');
  if(tabId==='rankings') renderRankings();
  if(tabId==='log') renderLogForm();
  if(tabId==='tournament') renderTournaments();
  if(tabId==='history') renderHistory();
  if(tabId==='h2h') renderH2HSelects();
  if(tabId==='verify') renderVerify();
}
document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));

// ‚îÄ‚îÄ‚îÄ PENDING BADGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updatePendingBadge(){
  const n=pendingMatches.length;
  const badge=el('pending-count-badge');
  if(n>0&&isAdmin){badge.textContent=n;badge.style.display='';}
  else badge.style.display='none';
}

// ‚îÄ‚îÄ‚îÄ RANKINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setRankView(v){rankView=v;document.querySelectorAll('.seg').forEach(b=>b.classList.toggle('active',b.dataset.rv===v));renderRankings();}
function toggleAddPlayer(){const f=el('add-player-form');f.classList.toggle('hidden');if(!f.classList.contains('hidden'))el('new-player-name').focus();}
function addPlayer(){
  if(!isAdmin){showToast('Admin only',false);return;}
  const name=el('new-player-name').value.trim();
  if(!name||players.find(p=>p.name.toLowerCase()===name.toLowerCase())){showToast('Name taken or empty',false);return;}
  players.push({id:'p'+Date.now(),name});
  saveData();el('new-player-name').value='';el('add-player-form').classList.add('hidden');
  showToast(name+' added! üéæ');renderRankings();renderLogForm();populatePlayerBanner();populateH2HSelects();
}
function renderRankings(){
  const stats=computeStats();
  const bucket=rankView==='singles'?stats.singles:stats.doubles;
  const sorted=sortedPlayers(bucket);
  el('rank-subtitle').textContent=`${players.length} players ¬∑ base 1200 ¬∑ ${rankView}`;
  const list=el('rankings-list');list.innerHTML='';
  sorted.forEach((p,i)=>{
    const diff=p.elo-1200,wr=p.matches>0?Math.round(p.wins/p.matches*100):0,col=rankColor(i);
    const div=document.createElement('div');div.className='row anim';div.style.animationDelay=(i*40)+'ms';
    div.innerHTML=`
      <div style="font-family:'Bebas Neue',sans-serif;font-size:16px;color:${col};min-width:28px;text-align:center;">#${i+1}</div>
      <div style="flex:1;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1px;color:#f1f5f9;">${p.name}</div>
        <div style="display:flex;gap:10px;margin-top:3px;flex-wrap:wrap;">
          <span style="font-size:11px;color:var(--green);font-family:'DM Mono',monospace;">${p.wins}W</span>
          <span style="font-size:11px;color:var(--red);font-family:'DM Mono',monospace;">${p.losses}L</span>
          <span style="font-size:11px;color:var(--dim);font-family:'DM Mono',monospace;">${p.matches} played</span>
          ${p.matches>0?`<span style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;">${wr}% WR</span>`:''}
        </div>
      </div>
      <div style="text-align:right;display:flex;align-items:center;gap:10px;">
        <div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:25px;color:${col};">${p.elo}</div>
          ${p.matches>0?`<div style="font-size:11px;font-family:'DM Mono',monospace;color:${diff>=0?'var(--green)':'var(--red)'};">${diff>=0?'+':''}${diff}</div>`:''}
        </div>
        ${isAdmin?`<button class="btn ghost sm" style="padding:5px 9px;font-size:13px;" onclick="openEditModal('${p.id}')">‚úèÔ∏è</button>`:''}
      </div>`;
    list.appendChild(div);
  });
}

// ‚îÄ‚îÄ‚îÄ LOG / SUBMIT MATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let logType='singles_1set';
function renderLogForm(){
  el('no-player-warning').classList.toggle('hidden',!!currentPlayerId);
  const wrap=el('match-type-btns');wrap.innerHTML='';
  Object.entries(MATCH_TYPES).forEach(([k,v])=>{
    const b=document.createElement('button');b.className='type-btn'+(logType===k?' active':'');
    b.textContent=`${v.emoji} ${v.doubles?'Doubles':'Singles'} ‚Äì ${v.label}`;
    b.onclick=()=>{logType=k;renderLogForm();};wrap.appendChild(b);
  });
  const ps=el('player-selects');
  const isD=MATCH_TYPES[logType]?.doubles;
  const stats=computeStats();
  const bucket=isD?stats.doubles:stats.singles;
  const makeSelect=(id,lbl,col,lockToCurrentPlayer=false)=>{
    const opts=players.map(p=>`<option value="${p.id}"${lockToCurrentPlayer&&p.id===currentPlayerId?' selected':''}>${p.name} (${(bucket[p.id]||freshStats()).elo})</option>`).join('');
    return `<div><label style="color:${col};">${lbl}</label><select class="inp" id="${id}"${lockToCurrentPlayer?' disabled style="opacity:.7;"':''}>
      <option value="">Select‚Ä¶</option>${opts}</select></div>`;
  };
  // Pre-fill submitter's name where appropriate
  ps.innerHTML=makeSelect('log-w1','üèÜ WINNER'+(isD?' 1':''),'var(--green)')+
               makeSelect('log-l1','üíÄ LOSER'+(isD?' 1':''),'var(--red)')+
               (isD?makeSelect('log-w2','üèÜ WINNER 2','var(--green)')+makeSelect('log-l2','üíÄ LOSER 2','var(--red)'):'');
  if(!el('log-date').value) el('log-date').value=new Date().toISOString().split('T')[0];
  updateTourneySelect();
}
function toggleTourneySelect(){const c=el('is-tourney').checked;el('tourney-select-wrap').classList.toggle('hidden',!c);if(c)updateTourneySelect();}
function updateTourneySelect(){
  const open=tournaments.filter(t=>t.status==='active');
  const sel=el('log-tourney-id');
  sel.innerHTML='<option value="">Link to tournament‚Ä¶</option>'+open.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  el('no-tourney-msg').classList.toggle('hidden',open.length>0);
  sel.classList.toggle('hidden',open.length===0);
}
function submitMatch(){
  if(!currentPlayerId){showToast('Select your name first',false);return;}
  const isD=MATCH_TYPES[logType]?.doubles;
  const w1=el('log-w1')?.value,l1=el('log-l1')?.value;
  const w2=isD?el('log-w2')?.value:'',l2=isD?el('log-l2')?.value:'';
  if(!w1||!l1||(isD&&(!w2||!l2))){showToast('Select all players',false);return;}
  const ids=isD?[w1,w2,l1,l2]:[w1,l1];
  if(new Set(ids).size<ids.length){showToast('Players must be unique',false);return;}
  const isTourney=el('is-tourney').checked;
  const rec={
    id:'m'+Date.now(),type:logType,
    winners:[w1,...(isD?[w2]:[])],losers:[l1,...(isD?[l2]:[])],
    score:el('log-score').value,date:el('log-date').value,
    tournamentId:isTourney?el('log-tourney-id').value||null:null,
    submittedBy:currentPlayerId,submittedAt:new Date().toISOString(),
  };
  pendingMatches.unshift(rec);saveData();updatePendingBadge();
  el('log-score').value='';
  showToast('Match submitted! Awaiting admin verification ‚è≥');
  renderLogForm();
}

// ‚îÄ‚îÄ‚îÄ VERIFY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderVerify(){
  const list=el('verify-list');
  el('reject-all-btn').style.display=pendingMatches.length>1?'':'none';
  if(!pendingMatches.length){
    list.innerHTML='<div style="text-align:center;color:var(--dimmer);padding:60px;font-family:\'DM Mono\',monospace;">No pending matches ‚úÖ</div>';
    return;
  }
  list.innerHTML='';
  pendingMatches.forEach((m,i)=>{
    const mt=MATCH_TYPES[m.type];
    const wStr=m.winners.map(pName).join(' & '),lStr=m.losers.map(pName).join(' & ');
    const submitter=m.submittedBy?pName(m.submittedBy):'Unknown';
    const t=m.tournamentId?tournaments.find(x=>x.id===m.tournamentId):null;
    const div=document.createElement('div');
    div.className='row anim pending-row';div.style.flexDirection='column';div.style.alignItems='flex-start';div.style.gap='8px';
    div.style.animationDelay=(i*35)+'ms';
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;width:100%;align-items:center;flex-wrap:wrap;gap:5px;">
        <div style="display:flex;gap:5px;flex-wrap:wrap;">
          <span class="pending-badge">‚è≥ PENDING</span>
          <span class="chip">${mt?.emoji} ${mt?.doubles?'Doubles':'Singles'} ‚Äì ${mt?.label}</span>
          ${t?`<span class="chip">üèÜ ${t.name}</span>`:''}
        </div>
        <span style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;">${m.date}</span>
      </div>
      <div style="display:flex;align-items:center;gap:9px;flex-wrap:wrap;">
        <span style="font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--green);">${wStr}</span>
        <span style="color:var(--dimmer);font-size:12px;">def.</span>
        <span style="font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--red);">${lStr}</span>
        ${m.score?`<span style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;">${m.score}</span>`:''}
      </div>
      <div style="font-size:11px;color:var(--dim);font-family:'DM Mono',monospace;">Submitted by ${submitter}</div>
      <div class="verify-actions">
        <button class="btn success sm" onclick="approveMatch('${m.id}')">‚úÖ APPROVE</button>
        <button class="btn danger sm" onclick="rejectMatch('${m.id}')">‚ùå REJECT</button>
      </div>`;
    list.appendChild(div);
  });
}
function approveMatch(mId){
  const idx=pendingMatches.findIndex(m=>m.id===mId);if(idx===-1) return;
  const m=pendingMatches.splice(idx,1)[0];
  matches.unshift(m);saveData();updatePendingBadge();
  showToast('Match approved ‚úÖ');renderVerify();renderRankings();
}
function rejectMatch(mId){
  pendingMatches=pendingMatches.filter(m=>m.id!==mId);
  saveData();updatePendingBadge();showToast('Match rejected');renderVerify();
}
function rejectAllPending(){
  if(!confirm('Reject ALL pending matches?')) return;
  pendingMatches=[];saveData();updatePendingBadge();showToast('All pending matches rejected');renderVerify();
}

// ‚îÄ‚îÄ‚îÄ EDIT / DELETE PLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditModal(id){
  if(!isAdmin){showToast('Admin only',false);return;}
  editingPlayerId=id;
  el('edit-player-name').value=players.find(p=>p.id===id)?.name||'';
  el('edit-modal').classList.remove('hidden');
  setTimeout(()=>el('edit-player-name').focus(),100);
}
function closeEditModal(){el('edit-modal').classList.add('hidden');editingPlayerId=null;}
function saveEditPlayer(){
  const name=el('edit-player-name').value.trim();
  if(!name){showToast('Enter a name',false);return;}
  if(players.find(p=>p.name.toLowerCase()===name.toLowerCase()&&p.id!==editingPlayerId)){showToast('Name taken',false);return;}
  const p=players.find(x=>x.id===editingPlayerId);if(p) p.name=name;
  saveData();closeEditModal();showToast('Player updated ‚úÖ');
  renderRankings();renderLogForm();populatePlayerBanner();populateH2HSelects();
}
function deletePlayer(){
  const p=players.find(x=>x.id===editingPlayerId);if(!p) return;
  if(!confirm(`Delete ${p.name}?`)) return;
  players=players.filter(x=>x.id!==editingPlayerId);
  saveData();closeEditModal();showToast(`${p.name} deleted`);
  renderRankings();renderLogForm();populatePlayerBanner();populateH2HSelects();
}

// ‚îÄ‚îÄ‚îÄ TOURNAMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeBracket(parts){
  let slots=[...parts];const n=Math.pow(2,Math.ceil(Math.log2(Math.max(slots.length,2))));
  while(slots.length<n)slots.push(null);
  const rounds=[];let cur=slots;
  while(cur.length>1){const ms=[];for(let i=0;i<cur.length;i+=2)ms.push({p1:cur[i],p2:cur[i+1],winner:null});rounds.push(ms);cur=ms.map(()=>null);}
  return rounds;
}
function setTForm(key,val,btn){
  tFormState[key]=val;
  if(btn){document.querySelectorAll(`[data-tf="${key}"]`).forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
  // Hide match type select for KOTC
  if(key==='type'){
    const matchTypeDiv=el('match-type-select-div');
    if(matchTypeDiv){
      matchTypeDiv.style.display=val==='kotc'?'none':'block';
    }
  }
  renderParticipantTags();
}
function renderParticipantTags(){
  const wrap=el('t-participants-wrap');wrap.classList.toggle('hidden',tFormState.type==='kotc');
  const tags=el('t-participants-tags');tags.innerHTML='';
  players.forEach(p=>{
    const span=document.createElement('span');span.className='tag'+(tFormState.participants.includes(p.id)?' sel':'');
    span.textContent=p.name;
    span.onclick=()=>{if(tFormState.participants.includes(p.id))tFormState.participants=tFormState.participants.filter(x=>x!==p.id);else tFormState.participants.push(p.id);renderParticipantTags();};
    tags.appendChild(span);
  });
  el('t-participants-count').textContent=tFormState.participants.length>0?tFormState.participants.length+' selected':'';
}
function createTournament(){
  const name=el('t-name').value.trim();
  if(!name){showToast('Give it a name',false);return;}
  if(tFormState.type==='bracket'&&tFormState.participants.length<2){showToast('Add 2+ participants',false);return;}
  const t={id:'t'+Date.now(),name,type:tFormState.type,isDoubles:tFormState.isDoubles,matchType:el('t-match-type').value,
    participants:[...tFormState.participants],rounds:tFormState.type==='bracket'?makeBracket(tFormState.participants):[],
    status:'active',champion:null,runnerUp:null,winner:null,second:null,createdAt:new Date().toISOString().split('T')[0]};
  tournaments.push(t);saveData();activeTourneyId=t.id;tFormState.participants=[];
  el('t-name').value='';renderParticipantTags();showToast(t.name+' created! üèÜ');renderTournaments();
}
function setRoundWinner(tId,ri,mi,winnerId){
  const t=tournaments.find(x=>x.id===tId);if(!t) return;
  t.rounds[ri][mi].winner=winnerId;
  if(ri+1<t.rounds.length){const slot=Math.floor(mi/2),isF=mi%2===0;if(isF)t.rounds[ri+1][slot].p1=winnerId;else t.rounds[ri+1][slot].p2=winnerId;}
  if(ri===t.rounds.length-1){t.champion=winnerId;t.runnerUp=[t.rounds[ri][mi].p1,t.rounds[ri][mi].p2].find(id=>id&&id!==winnerId)||null;t.status='done';showToast('Tournament complete! üèÜ');}
  saveData();renderTournaments();renderRankings();
}
function kotcPlacementEloFn(i){return kotcPlacementElo(i);}
function addKotcPlace(tId){const t=tournaments.find(x=>x.id===tId);if(!t)return;if(!t.placements)t.placements=[];t.placements.push('');saveData();renderTournaments();}
function removeKotcPlace(tId,idx){const t=tournaments.find(x=>x.id===tId);if(!t)return;t.placements.splice(idx,1);saveData();renderTournaments();}
function updateKotcPlacement(tId,idx,pid){const t=tournaments.find(x=>x.id===tId);if(!t)return;if(!t.placements)t.placements=[];t.placements[idx]=pid;saveData();}
function finishKotc(tId){
  const t=tournaments.find(x=>x.id===tId);if(!t)return;
  const placements=[];let i=0;
  while(true){const s=el(`kotc-place-${tId}-${i}`);if(!s)break;placements.push(s.value);i++;}
  if(!placements.length){showToast('Add at least one placement',false);return;}
  if(placements.some(p=>!p)){showToast('Select a player for each place',false);return;}
  if(new Set(placements).size<placements.length){showToast('Each player can only appear once',false);return;}
  t.placements=placements;t.winner=[placements[0]];t.second=placements[1]?[placements[1]]:[];t.status='done';
  saveData();showToast('King of the Court complete! üëë');renderTournaments();renderRankings();
}
function deleteTournament(tId){
  if(!isAdmin){showToast('Admin access required',false);return;}
  const idx=tournaments.findIndex(t=>t.id===tId);
  if(idx===-1)return;
  tournaments.splice(idx,1);
  // Also remove any matches linked to this tournament
  matches=matches.filter(m=>m.tournamentId!==tId);
  pendingMatches=pendingMatches.filter(m=>m.tournamentId!==tId);
  saveData();
  activeTourneyId=null;
  showToast('Tournament deleted');
  renderTournaments();
  renderHistory();
  renderVerify();
}
function renderTournaments(){
  renderParticipantTags();
  const list=el('tournament-list');
  // Filter to only show active tournaments
  const activeTournaments=tournaments.filter(t=>t.status!=='done');
  if(!activeTournaments.length){list.innerHTML='<div style="text-align:center;color:var(--dimmer);padding:40px;font-family:\'DM Mono\',monospace;">No active tournaments</div>';return;}
  list.innerHTML='';
  [...activeTournaments].reverse().forEach(t=>{
    const isOpen=activeTourneyId===t.id;
    const div=document.createElement('div');div.className='row anim';div.style.cssText='flex-direction:column;align-items:stretch;gap:10px;padding:14px;';
    let inner=`<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#f1f5f9;letter-spacing:1px;">${t.name}</span>
        <span class="chip">${t.type==='kotc'?'üëë KOTC':'üèÜ Bracket'} ¬∑ ${t.isDoubles?'Doubles':'Singles'}</span>
        ${t.status==='done'?'<span class="badge-done">COMPLETE</span>':'<span class="badge-active">ACTIVE</span>'}
      </div>
      <div style="display:flex;gap:8px;">
        ${isAdmin?`<button class="btn danger sm" onclick="if(confirm('Delete this tournament? This cannot be undone.'))deleteTournament('${t.id}')">üóë</button>`:''}
        <button class="btn ghost sm" onclick="activeTourneyId=activeTourneyId==='${t.id}'?null:'${t.id}';renderTournaments();">${isOpen?'‚ñ≤ HIDE':'‚ñº MANAGE'}</button>
      </div>
    </div>`;
    if(isOpen&&t.type==='bracket'){
      inner+=`<div class="scroll-x"><div style="display:flex;gap:18px;min-width:max-content;">`;
      t.rounds.forEach((round,ri)=>{
        const rLabel=ri===t.rounds.length-1?'FINAL':ri===t.rounds.length-2&&t.rounds.length>2?'SEMIS':`R${ri+1}`;
        inner+=`<div><div style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;margin-bottom:8px;letter-spacing:1px;">${rLabel}</div><div style="display:flex;flex-direction:column;gap:10px;">`;
        round.forEach((m,mi)=>{
          inner+=`<div class="bracket-cell" style="border-color:${m.winner?'rgba(34,197,94,.3)':'var(--border2)'};">`;
          [m.p1,m.p2].forEach(pid=>{
            const canClick=pid&&!m.winner&&t.status==='active';const won=m.winner===pid;
            inner+=`<div class="b-player${won?' won':''}${!pid?' bye':''}" style="background:${won?'#14532d':''};color:${won?'#86efac':pid?'var(--text)':'var(--dimmer)'};cursor:${canClick?'pointer':'default'};" ${canClick?`onclick="setRoundWinner('${t.id}',${ri},${mi},'${pid}')"`:''}>${pid?pName(pid):'BYE'}${won?'<span style="margin-left:6px;font-size:11px;">‚úì</span>':''}</div>`;
          });
          if(!m.p1&&!m.p2)inner+=`<div style="font-size:12px;color:var(--dimmer);font-family:'DM Mono',monospace;padding:4px 6px;">TBD</div>`;
          inner+=`</div>`;
        });
        inner+=`</div></div>`;
      });
      inner+=`</div></div>`;
      if(t.status==='done'&&t.champion){inner+=`<div style="padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--border);display:flex;gap:16px;flex-wrap:wrap;"><span>ü•á <span style="color:var(--gold);font-family:'Bebas Neue',sans-serif;font-size:15px;">${pName(t.champion)}</span><span style="color:var(--dimmer);font-size:11px;font-family:'DM Mono',monospace;margin-left:5px;">+${K_FACTORS.tournament_bonus_winner} ELO</span></span>${t.runnerUp?`<span>ü•à <span style="color:var(--silver);font-family:'Bebas Neue',sans-serif;font-size:15px;">${pName(t.runnerUp)}</span><span style="color:var(--dimmer);font-size:11px;font-family:'DM Mono',monospace;margin-left:5px;">+${K_FACTORS.tournament_bonus_runner} ELO</span></span>`:''}</div>`;}
    }
    if(isOpen&&t.type==='kotc'&&t.status==='active'){
      const opts=players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      const pl=t.placements||[];
      let rows='';
      for(let i=0;i<pl.length;i++){const ev=kotcPlacementElo(i);const ec=ev>0?'var(--green)':ev<0?'var(--red)':'var(--dim)';rows+=`<div class="kotc-place-row"><span class="kotc-place-badge" style="color:${i===0?'var(--gold)':i===1?'var(--silver)':i===2?'var(--bronze)':'var(--dim)'};">#${i+1}</span><select class="inp" style="flex:1;" id="kotc-place-${t.id}-${i}" onchange="updateKotcPlacement('${t.id}',${i},this.value)"><option value="">Select‚Ä¶</option>${opts}</select><span class="kotc-elo-badge" style="color:${ec};">${ev>0?'+':''}${ev}</span><button class="btn danger sm" style="padding:5px 8px;" onclick="removeKotcPlace('${t.id}',${i})">‚úï</button></div>`;}
      inner+=`<div style="padding:14px;background:var(--bg);border-radius:10px;border:1px solid var(--border);"><div style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;letter-spacing:1px;margin-bottom:10px;">FINAL LEADERBOARD ¬∑ 1st +20, 2nd +5, 3rd 0, 4th -5, ‚Ä¶</div><div id="kotc-places-${t.id}">${rows}</div><div style="display:flex;gap:8px;margin-top:8px;"><button class="btn ghost sm" onclick="addKotcPlace('${t.id}')">+ ADD PLACE</button><button class="btn pri sm" onclick="finishKotc('${t.id}')">FINISH KOTC</button></div></div>`;
      setTimeout(()=>{const pls=tournaments.find(x=>x.id===t.id)?.placements||[];pls.forEach((pid,i)=>{const s=el(`kotc-place-${t.id}-${i}`);if(s&&pid)s.value=pid;});},0);
    }
    if(isOpen&&t.type==='kotc'&&t.status==='done'){
      const pl=t.placements||[];const rows=pl.map((pid,i)=>{const ev=kotcPlacementElo(i);const ec=ev>0?'var(--green)':ev<0?'var(--red)':'var(--dim)';return`<div style="display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid var(--border);"><span style="font-family:'Bebas Neue',sans-serif;font-size:14px;color:${i===0?'var(--gold)':i===1?'var(--silver)':i===2?'var(--bronze)':'var(--dim)'};min-width:26px;">#${i+1}</span><span style="flex:1;font-family:'Bebas Neue',sans-serif;font-size:16px;color:#f1f5f9;">${pName(pid)}</span><span style="font-family:'DM Mono',monospace;font-size:12px;color:${ec};">${ev>0?'+':''}${ev} ELO</span></div>`;}).join('');
      inner+=`<div style="padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--border);">${rows||'No placements'}</div>`;
    }
    div.innerHTML=inner;list.appendChild(div);
  });
}

// ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let expandedHistoryItems = new Set();

function toggleHistoryDetails(id){
  if(expandedHistoryItems.has(id)){
    expandedHistoryItems.delete(id);
  } else {
    expandedHistoryItems.add(id);
  }
  renderHistory();
}

function deleteMatch(matchId){
  if(!isAdmin){showToast('Admin access required',false);return;}
  const idx=matches.findIndex(m=>m.id===matchId);
  if(idx===-1)return;
  matches.splice(idx,1);
  saveData();
  showToast('Match deleted');
  renderHistory();
  renderRankings();
}

function renderHistory(){
  const list=el('history-list');
  const completedTournaments=tournaments.filter(t=>t.status==='done');
  if(!matches.length&&!completedTournaments.length){list.innerHTML='<div style="text-align:center;color:var(--dimmer);padding:60px;font-family:\'DM Mono\',monospace;">No history yet üéæ</div>';return;}
  list.innerHTML='';
  
  // Render completed tournaments first
  if(completedTournaments.length>0){
    const tourneySection=document.createElement('div');
    tourneySection.style.cssText='margin-bottom:24px;';
    tourneySection.innerHTML='<div style="font-family:\'Bebas Neue\',sans-serif;font-size:15px;letter-spacing:2px;color:var(--dim);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);">COMPLETED TOURNAMENTS</div>';
    list.appendChild(tourneySection);
    
    [...completedTournaments].reverse().forEach((t,idx)=>{
      const tId='tourney-'+t.id;
      const isExpanded=expandedHistoryItems.has(tId);
      const div=document.createElement('div');div.className='row anim';div.style.cssText='flex-direction:column;align-items:flex-start;gap:8px;';div.style.animationDelay=(idx*28)+'ms';
      let inner=`<div style="display:flex;justify-content:space-between;width:100%;align-items:center;flex-wrap:wrap;gap:8px;">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#f1f5f9;letter-spacing:1px;">${t.name}</span>
          <span class="chip">${t.type==='kotc'?'üëë KOTC':'üèÜ Bracket'} ¬∑ ${t.isDoubles?'Doubles':'Singles'}</span>
          <span class="badge-done">COMPLETE</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;">${t.createdAt||''}</span>
          <button class="btn ghost sm" onclick="toggleHistoryDetails('${tId}')" style="padding:4px 8px;">${isExpanded?'‚ñ≤':'‚ñº'}</button>
        </div>
      </div>`;
      
      if(t.type==='bracket'&&t.champion){
        inner+=`<div style="display:flex;gap:16px;flex-wrap:wrap;"><span>ü•á <span style="color:var(--gold);font-family:'Bebas Neue',sans-serif;font-size:15px;">${pName(t.champion)}</span></span>${t.runnerUp?`<span>ü•à <span style="color:var(--silver);font-family:'Bebas Neue',sans-serif;font-size:15px;">${pName(t.runnerUp)}</span></span>`:''}</div>`;
      }
      
      if(t.type==='kotc'&&t.placements){
        const top3=t.placements.slice(0,3);
        const medals=['ü•á','ü•à','ü•â'];
        const colors=['var(--gold)','var(--silver)','var(--bronze)'];
        inner+=`<div style="display:flex;gap:12px;flex-wrap:wrap;">${top3.map((pid,i)=>`<span>${medals[i]} <span style="color:${colors[i]};font-family:'Bebas Neue',sans-serif;font-size:15px;">${pName(pid)}</span></span>`).join('')}</div>`;
      }
      
      // K Distribution details for tournaments
      if(isExpanded){
        inner+=`<div style="padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--border);width:100%;"><div style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;letter-spacing:1px;margin-bottom:8px;">üìä ELO DISTRIBUTION</div>`;
        if(t.type==='bracket'){
          inner+=`<div style="display:flex;flex-direction:column;gap:4px;">`;
          if(t.champion){
            inner+=`<div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-size:13px;">ü•á ${pName(t.champion)} (Champion)</span><span style="color:var(--green);font-family:'DM Mono',monospace;font-size:12px;">+${K_FACTORS.tournament_bonus_winner} ELO</span></div>`;
          }
          if(t.runnerUp){
            inner+=`<div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-size:13px;">ü•à ${pName(t.runnerUp)} (Runner-up)</span><span style="color:var(--green);font-family:'DM Mono',monospace;font-size:12px;">+${K_FACTORS.tournament_bonus_runner} ELO</span></div>`;
          }
          inner+=`<div style="margin-top:4px;padding-top:8px;border-top:1px solid var(--border);font-size:12px;color:var(--dim);">Each match: K=${K_FACTORS[t.matchType]} + ${K_FACTORS.tournament_match_bonus} tournament bonus</div>`;
          inner+=`</div>`;
        }
        if(t.type==='kotc'&&t.placements){
          inner+=`<div style="display:flex;flex-direction:column;gap:4px;">`;
          t.placements.forEach((pid,i)=>{
            const eloChange=kotcPlacementElo(i);
            const eloColor=eloChange>0?'var(--green)':eloChange<0?'var(--red)':'var(--dim)';
            const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`#${i+1}`;
            inner+=`<div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-size:13px;">${medal} ${pName(pid)}</span><span style="color:${eloColor};font-family:'DM Mono',monospace;font-size:12px;">${eloChange>0?'+':''}${eloChange} ELO</span></div>`;
          });
          inner+=`</div>`;
        }
        inner+=`</div>`;
      }
      
      div.innerHTML=inner;
      list.appendChild(div);
    });
    
    // Add separator before matches if there are any
    if(matches.length>0){
      const separator=document.createElement('div');
      separator.style.cssText='margin:24px 0;padding-top:12px;border-top:1px solid var(--border);';
      separator.innerHTML='<div style="font-family:\'Bebas Neue\',sans-serif;font-size:15px;letter-spacing:2px;color:var(--dim);margin-bottom:12px;">MATCH HISTORY</div>';
      list.appendChild(separator);
    }
  }
  
  // Render matches
  matches.forEach((m,i)=>{
    const matchId='match-'+i;
    const isExpanded=expandedHistoryItems.has(matchId);
    const mt=MATCH_TYPES[m.type];const t=m.tournamentId?tournaments.find(x=>x.id===m.tournamentId):null;
    const wStr=m.winners.map(pName).join(' & '),lStr=m.losers.map(pName).join(' & ');
    const div=document.createElement('div');div.className='row anim';div.style.cssText='flex-direction:column;align-items:flex-start;gap:5px;';div.style.animationDelay=((completedTournaments.length+i)*28)+'ms';
    
    // Calculate K distribution for this match
    const isD=mt?.doubles??false;
    const kBase=K_FACTORS[m.type]+(m.tournamentId?K_FACTORS.tournament_match_bonus:0);
    
    let inner=`<div style="display:flex;justify-content:space-between;width:100%;align-items:center;flex-wrap:wrap;gap:4px;">
      <div style="display:flex;gap:5px;flex-wrap:wrap;align-items:center;">
        <span class="chip">${mt?.emoji} ${mt?.doubles?'Doubles':'Singles'} ‚Äì ${mt?.label}</span>
        ${t?`<span class="chip">üèÜ ${t.name}</span>`:''}
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;">${m.date}</span>
        ${isAdmin?`<button class="btn danger sm" onclick="if(confirm('Delete this match?'))deleteMatch('${m.id}')" style="padding:4px 8px;">üóë</button>`:''}
        <button class="btn ghost sm" onclick="toggleHistoryDetails('${matchId}')" style="padding:4px 8px;">${isExpanded?'‚ñ≤':'‚ñº'}</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <span style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--green);">${wStr}</span>
      <span style="color:var(--dimmer);font-size:12px;">def.</span>
      <span style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--red);">${lStr}</span>
      ${m.score?`<span style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;">${m.score}</span>`:''}
    </div>`;
    
    // K Distribution details for matches
    if(isExpanded){
      inner+=`<div style="padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--border);width:100%;margin-top:4px;">
        <div style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;letter-spacing:1px;margin-bottom:8px;">üìä K-FACTOR BREAKDOWN</div>
        <div style="display:flex;flex-direction:column;gap:4px;font-size:13px;">
          <div style="display:flex;justify-content:space-between;"><span>Base K-Factor (${mt?.label})</span><span style="font-family:'DM Mono',monospace;color:var(--muted);">K=${K_FACTORS[m.type]}</span></div>
          ${m.tournamentId?`<div style="display:flex;justify-content:space-between;"><span>Tournament Bonus</span><span style="font-family:'DM Mono',monospace;color:var(--accent);">+${K_FACTORS.tournament_match_bonus}</span></div>`:''}
          <div style="border-top:1px solid var(--border);margin:4px 0;"></div>
          <div style="display:flex;justify-content:space-between;font-family:'Bebas Neue',sans-serif;font-size:14px;"><span>Total K-Factor</span><span style="color:var(--accent);">K=${kBase}</span></div>
          <div style="margin-top:8px;font-size:12px;color:var(--dim);">
            ${!isD?'‚Ä¢ Upset bonus: +5 ELO per rank (if winner ranked 3+ below loser)<br>‚Ä¢ Choke penalty: -5 base -5/rank (if loser ranked 3+ below winner)':'‚Ä¢ Doubles uses average team ELO and ranks<br>‚Ä¢ Same upset/choke modifiers apply'}
          </div>
        </div>
      </div>`;
    }
    
    div.innerHTML=inner;
    list.appendChild(div);
  });
}

// ‚îÄ‚îÄ‚îÄ H2H ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateH2HSelects(){const opts='<option value="">Select‚Ä¶</option>'+players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');el('h2h-a').innerHTML=opts;el('h2h-b').innerHTML=opts;}
function renderH2HSelects(){populateH2HSelects();renderH2H();}
function renderH2H(){
  const aId=el('h2h-a').value,bId=el('h2h-b').value,res=el('h2h-result');
  if(!aId||!bId||aId===bId){res.innerHTML='<div style="text-align:center;color:var(--dimmer);padding:50px;font-family:\'DM Mono\',monospace;">Select two players ‚öîÔ∏è</div>';return;}
  const ms=matches.filter(m=>[...m.winners,...m.losers].includes(aId)&&[...m.winners,...m.losers].includes(bId));
  const aW=ms.filter(m=>m.winners.includes(aId)).length,bW=ms.filter(m=>m.winners.includes(bId)).length;
  let html=`<div class="card mb12" style="text-align:center;">`;
  if(ms.length>0){html+=`<div style="display:flex;justify-content:center;align-items:center;gap:40px;">${[[aId,aW,bW],[bId,bW,aW]].map(([id,w,l])=>`<div><div style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#f1f5f9;">${pName(id)}</div><div style="font-family:'Bebas Neue',sans-serif;font-size:56px;line-height:1;color:${w>l?'var(--accent)':'var(--dim)'};">${w}</div></div>`).join('<div style="font-family:\'Bebas Neue\',sans-serif;font-size:18px;color:var(--border2);">‚Äî</div>')}</div><div style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;margin-top:5px;">${ms.length} matches</div>`;}
  else html+=`<div style="color:var(--dimmer);font-family:'DM Mono',monospace;">No matches between these players yet</div>`;
  html+=`</div>`;
  ms.forEach(m=>{const mt=MATCH_TYPES[m.type];html+=`<div class="row" style="flex-direction:column;align-items:flex-start;gap:5px;"><div style="display:flex;justify-content:space-between;width:100%;"><span class="chip">${mt?.emoji} ${mt?.doubles?'Doubles':'Singles'} ‚Äì ${mt?.label}</span><span style="font-size:11px;color:var(--dimmer);font-family:'DM Mono',monospace;">${m.date}</span></div><div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;"><span style="font-family:'Bebas Neue',sans-serif;font-size:17px;color:var(--green);">${m.winners.map(pName).join(' & ')}</span><span style="color:var(--dimmer);font-size:12px;">def.</span><span style="font-family:'Bebas Neue',sans-serif;font-size:17px;color:var(--red);">${m.losers.map(pName).join(' & ')}</span>${m.score?`<span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);">${m.score}</span>`:''}</div></div>`;});
  res.innerHTML=html;
}

// ‚îÄ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    closePinModal();
    closeEditModal();
    closeSetPinModal();
  }
  // Enter in edit modal = save player
  if(e.key==='Enter' && !el('edit-modal').classList.contains('hidden')){
    e.preventDefault(); saveEditPlayer();
  }
  // Enter in set-pin modal = save pin
  if(e.key==='Enter' && !el('setpin-modal').classList.contains('hidden')){
    e.preventDefault(); savePin();
  }
});

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadData();
populatePlayerBanner();
renderRankings();
renderLogForm();
renderParticipantTags();
populateH2HSelects();
updatePendingBadge();
</script>
</body>
</html>
